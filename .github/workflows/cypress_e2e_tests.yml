name: Cypress E2E Tests
on:
#  schedule:
#    - cron: '0 0 * * *'  # every day at midnight
  push:
    branches:
      - bbrooks/3227-Cypress-CI

jobs:
  cypress-run:
    environment: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
#      - name: Setup npm package Frontend
#        working-directory: ./web
#        run: |
#          npm ci
#          npm install
#          npm run start -- --public=0.0.0.0:8080 &
#      - name: Setup npm package Backend
#        working-directory: ./api
#        env:
#          OKTA_DOMAIN: ${{ secrets.OKTA_DOMAIN }}
#          OKTA_API_KEY: ${{ secrets.OKTA_API_KEY }}
#        run: |
#          npm ci
#          npm install
#          npm run start-dev &       
      - name: Cypress Dependency
        working-directory: ./integrationTests
        env:
          NODE_ENV: development
          OKTA_DOMAIN: ${{ secrets.OKTA_DOMAIN }}
          OKTA_API_KEY: ${{ secrets.OKTA_API_KEY }}          
        run: |
          npm install knex
          npm install cypress
          npm audit fix
      - name: Start the App
        env:
          NODE_ENV: development
          OKTA_DOMAIN: ${{ secrets.OKTA_DOMAIN }}
          OKTA_API_KEY: ${{ secrets.OKTA_API_KEY }}
          run: |
            docker-compose up
      - name: Testing CLI NPM Command
        if: ${{ always() }}
        working-directory: ./integrationTests
        env:
          NODE_ENV: development
          OKTA_DOMAIN: ${{ secrets.OKTA_DOMAIN }}
          OKTA_API_KEY: ${{ secrets.OKTA_API_KEY }}
        run: |
          npx cypress run --headless
      - name: Testing Script
        if: ${{ always() }}
        working-directory: ./integrationTests
        env:
          NODE_ENV: development
          OKTA_DOMAIN: ${{ secrets.OKTA_DOMAIN }}
          OKTA_API_KEY: ${{ secrets.OKTA_API_KEY }}
        run: |
          sh cypress-setup.sh run
      - name: Run E2E test
        if: ${{ always() }}
        uses: cypress-io/github-action@v2
        env: 
          NODE_ENV: development
          OKTA_DOMAIN: ${{ secrets.OKTA_DOMAIN }}
          OKTA_API_KEY: ${{ secrets.OKTA_API_KEY }}
        with:
          working-directory: ./integrationTests
          browser: chrome
          headless: true
          start: npm cypress run
      - name: Debugging Info
        working-directory: ./integrationTests
        run: |
          ls -la
          pwd
          find ./ -type f -name index.js



          #!/usr/bin/env sh

rm ./endpoint-tests/endpoint-data.json

export NODE_ENV=test
export API_URL=http://localhost:8081
export CYPRESS_TESTS=false
unset DEV_DB_NAME

echo "[]" > endpoint-data.json

ENDPOINT_COVERAGE_CAPTURE=true docker-compose -f docker-compose.endpoint-tests.yml up -d
docker-compose -f docker-compose.endpoint-tests.yml exec api-for-testing npm run migrate
docker-compose -f docker-compose.endpoint-tests.yml exec api-for-testing npm run seed
docker-compose -f docker-compose.endpoint-tests.yml exec api-for-testing npm run test-endpoints $@
EXIT_CODE=$?
docker-compose -f docker-compose.endpoint-tests.yml down

mv endpoint-data.json ./endpoint-tests

node endpoint-tests/endpoint-coverage.js
exit $EXIT_CODE
